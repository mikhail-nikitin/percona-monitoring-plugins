# Zabbix triggers for MySQL
#
# License: GPL License (see COPYING)
# Copyright: 2013 Percona
# Authors: Roman Vynar, Mikhail Nikitin

trigger_prototypes:
  # MySQL process
  - name: MySQL {#MYSQL_INSTANCE_NAME} is down on {HOST.NAME}
    expression: '{TEMPLATE:MySQL.heartbeat[{#MYSQL_INSTANCE}].last(0)}<>1'
    severity: Disaster

  # MySQL connections
  - name: MySQL {#MYSQL_INSTANCE_NAME} connections utilization more than {$CONNECTION_UTILIZATION_AVERAGE}% on {HOST.NAME}
    expression: '{TEMPLATE:MySQL.Threads-connected[{#MYSQL_INSTANCE}].last(0)}/{TEMPLATE:MySQL.max-connections[{#MYSQL_INSTANCE}].last(0)}>({$CONNECTION_UTILIZATION_AVERAGE}/100)'
    severity: Average
    dependencies: ['MySQL {#MYSQL_INSTANCE_NAME} connections utilization more than {$CONNECTION_UTILIZATION_HIGH}% on {HOST.NAME}']
  - name: MySQL {#MYSQL_INSTANCE_NAME} connections utilization more than {$CONNECTION_UTILIZATION_HIGH}% on {HOST.NAME}
    expression: '{TEMPLATE:MySQL.Threads-connected[{#MYSQL_INSTANCE}].last(0)}/{TEMPLATE:MySQL.max-connections[{#MYSQL_INSTANCE}].last(0)}>({$CONNECTION_UTILIZATION_HIGH}/100)'
    severity: High
    dependencies: ['MySQL {#MYSQL_INSTANCE_NAME} is down on {HOST.NAME}']

  # MySQL active threads (the triggers need refining)
  - name: MySQL {#MYSQL_INSTANCE_NAME} active threads more than {$ACTIVE_THREADS_AVERAGE} on {HOST.NAME}
    expression: '{TEMPLATE:MySQL.Threads-running[{#MYSQL_INSTANCE}].last(0)}>{$ACTIVE_THREADS_AVERAGE}'
    severity: Average
    dependencies: ['MySQL {#MYSQL_INSTANCE_NAME} active threads more than {$ACTIVE_THREADS_HIGH} on {HOST.NAME}']
  - name: MySQL {#MYSQL_INSTANCE_NAME} active threads more than {$ACTIVE_THREADS_HIGH} on {HOST.NAME}
    expression: '{TEMPLATE:MySQL.Threads-running[{#MYSQL_INSTANCE}].last(0)}>{$ACTIVE_THREADS_HIGH}'
    severity: High
    dependencies: ['MySQL {#MYSQL_INSTANCE_NAME} is down on {HOST.NAME}']

  # MySQL replication
  - name: MySQL {#MYSQL_INSTANCE_NAME} slave lag more than {$SLAVE_LAG_AVERAGE} on {HOST.NAME}
    category: slave
    expression: '{TEMPLATE:MySQL.slave-lag[{#MYSQL_INSTANCE}].last(0)}>{$SLAVE_LAG_AVERAGE}'
    severity: Average
    dependencies: ['MySQL {#MYSQL_INSTANCE_NAME} slave lag more than {$SLAVE_LAG_HIGH} on {HOST.NAME}']
  - name: MySQL {#MYSQL_INSTANCE_NAME} slave lag more than {$SLAVE_LAG_HIGH} on {HOST.NAME}
    category: slave
    expression: '{TEMPLATE:MySQL.slave-lag[{#MYSQL_INSTANCE}].last(0)}>{$SLAVE_LAG_HIGH}'
    severity: High
    dependencies: ['MySQL {#MYSQL_INSTANCE_NAME} slave stopped for {$SLAVE_STOP_TIME_HIGH} on {HOST.NAME}']
  - name: MySQL {#MYSQL_INSTANCE_NAME} slave stopped for {$SLAVE_STOP_TIME_AVERAGE} on {HOST.NAME}
    category: slave
    expression: '({TEMPLATE:MySQL.slave-io-running[{#MYSQL_INSTANCE}].last(0)}=0 or {TEMPLATE:MySQL.slave-sql-running[{#MYSQL_INSTANCE}].last(0)}=0) and ({TEMPLATE:MySQL.slave-io-running[{#MYSQL_INSTANCE}].avg({$SLAVE_STOP_TIME_AVERAGE})}<{$SLAVE_MIN_RUNNING_RATIO} or {TEMPLATE:MySQL.slave-sql-running[{#MYSQL_INSTANCE}].avg({$SLAVE_STOP_TIME_AVERAGE})}<{$SLAVE_MIN_RUNNING_RATIO})'
    severity: High
    dependencies: ['MySQL {#MYSQL_INSTANCE_NAME} slave stopped for {$SLAVE_STOP_TIME_HIGH} on {HOST.NAME}']
  - name: MySQL {#MYSQL_INSTANCE_NAME} slave stopped for {$SLAVE_STOP_TIME_HIGH} on {HOST.NAME}
    category: slave
    expression: '({TEMPLATE:MySQL.slave-io-running[{#MYSQL_INSTANCE}].last(0)}=0 or {TEMPLATE:MySQL.slave-sql-running[{#MYSQL_INSTANCE}].last(0)}=0) and ({TEMPLATE:MySQL.slave-io-running[{#MYSQL_INSTANCE}].avg({$SLAVE_STOP_TIME_HIGH})}<{$SLAVE_MIN_RUNNING_RATIO} or {TEMPLATE:MySQL.slave-sql-running[{#MYSQL_INSTANCE}].avg({$SLAVE_STOP_TIME_HIGH})}<{$SLAVE_MIN_RUNNING_RATIO})'
    severity: High
    dependencies:
      - MySQL {#MYSQL_INSTANCE_NAME} IO Error on {HOST.NAME}
      - MySQL {#MYSQL_INSTANCE_NAME} SQL Error on {HOST.NAME}
  - name: MySQL {#MYSQL_INSTANCE_NAME} IO Error on {HOST.NAME}
    category: slave
    expression: '{TEMPLATE:MySQL.slave-last-io-error[{#MYSQL_INSTANCE}].regexp(".")} and {TEMPLATE:MySQL.slave-io-running[{#MYSQL_INSTANCE}].avg({$SLAVE_CONNECTION_TIMEOUT})}<{$SLAVE_MIN_RUNNING_RATIO}'
    severity: High
  - name: MySQL {#MYSQL_INSTANCE_NAME} SQL Error on {HOST.NAME}
    category: slave
    expression: '{TEMPLATE:MySQL.slave-last-sql-error[{#MYSQL_INSTANCE}].regexp(".")}'
    severity: High

macros:
  '{$CONNECTION_UTILIZATION_AVERAGE}': 80
  '{$CONNECTION_UTILIZATION_HIGH}': 95
  '{$ACTIVE_THREADS_AVERAGE}': 40
  '{$ACTIVE_THREADS_HIGH}': 100
  '{$SLAVE_LAG_AVERAGE}': 300
  '{$SLAVE_LAG_HIGH}': 600
  '{$SLAVE_CONNECTION_TIMEOUT}': 30
  '{$SLAVE_STOP_TIME_AVERAGE}': 5m
  '{$SLAVE_STOP_TIME_HIGH}': 10m
  '{$SLAVE_MIN_RUNNING_RATIO}': 0.15

